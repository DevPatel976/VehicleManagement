{% extends "admin/layout.html" %}

{% block title %}Reservations Management - Admin Dashboard{% endblock %}

{% block head %}
{{ super() }}
<!-- Custom styles for this page -->
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<style>
    /* Ensure dropdowns work properly */
    .dropdown-menu {
        z-index: 1050 !important;
        position: absolute !important;
        min-width: 160px !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .dropdown-menu.show {
        display: block !important;
    }
    .table-responsive {
        overflow: visible !important;
    }
    .dropdown {
        position: relative !important;
    }
    /* Ensure dropdown doesn't get clipped by table boundaries */
    .table td:last-child .dropdown-menu {
        right: 0 !important;
        left: auto !important;
    }
    /* Additional fixes for dropdown visibility */
    .dropdown-toggle {
        cursor: pointer !important;
    }
    .dropdown-toggle::after {
        display: inline-block !important;
        margin-left: 0.255em !important;
        vertical-align: 0.255em !important;
        content: "" !important;
        border-top: 0.3em solid !important;
        border-right: 0.3em solid transparent !important;
        border-bottom: 0 !important;
        border-left: 0.3em solid transparent !important;
    }
    /* Force visibility of dropdowns */
    .table td {
        position: relative !important;
    }
    .table td .dropdown-menu.show {
        display: block !important;
        position: absolute !important;
        transform: translate3d(0px, 38px, 0px) !important;
        top: 0px !important;
        left: 0px !important;
        will-change: transform !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top:0; padding-top:0;">
    {% block admin_content %}
<div class="container-fluid" style="margin-top:0; padding-top:0;">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Reservations</h1>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addReservationModal">
            <i class="fas fa-plus fa-sm text-white-50"></i> Add New Reservation
        </a>
    </div>

    <!-- Content Row -->
    <div class="row">
        <div class="col-12">
            <!-- Filter Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Filters</h6>
                </div>
                <div class="card-body">
                    <form class="row g-3" method="GET">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   placeholder="ID, Username, or Spot Number" value="{{ request.args.get('search', '') }}">
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Status</option>
                                <option value="active" {{ 'selected' if filters.status == 'active' else '' }}>Active</option>
                                <option value="completed" {{ 'selected' if filters.status == 'completed' else '' }}>Completed</option>
                                <option value="cancelled" {{ 'selected' if filters.status == 'cancelled' else '' }}>Cancelled</option>
                                <option value="reversed" {{ 'selected' if filters.status == 'reversed' else '' }}>Reversed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="user_id" class="form-label">User</label>
                            <select class="form-select" id="user_id" name="user_id">
                                <option value="">All Users</option>
                                {% for user in users %}
                                <option value="{{ user.id }}" {{ 'selected' if filters.user_id == user.id|string else '' }}>
                                    {{ user.full_name or user.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="date_from" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" value="{{ filters.date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" value="{{ filters.date_to }}">
                        </div>
                        <div class="col-12 d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter me-1"></i> Apply Filters
                            </button>
                            <a href="{{ url_for('admin.reservations') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Clear Filters
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Reservations Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">All Reservations</h6>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="exportBtn" title="Export">
                            <i class="fas fa-file-export"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="printBtn" title="Print" onclick="window.print();">
                            <i class="fas fa-print"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshBtn" title="Refresh" onclick="window.location.reload();">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="reservationsTable" width="100%" cellspacing="0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Vehicle</th>
                                    <th>Parking Spot</th>
                                    <th>Check-In <small class="text-muted">(IST)</small></th>
                                    <th>Check-Out <small class="text-muted">(IST)</small></th>
                                    <th>Status</th>
                                    <th>Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reservation in reservations.items %}
                                <tr>
                                    <td>#{{ reservation.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; font-size: 12px;">
                                                {{ (reservation.user.full_name or reservation.user.username)[0] if (reservation.user.full_name or reservation.user.username) else 'U' }}
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ reservation.user.full_name or reservation.user.username }}</div>
                                                <div class="text-muted small">{{ reservation.user.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{ reservation.vehicle_registration or 'N/A' }}</div>
                                        <div class="text-muted small">{{ reservation.created_at|localtime('%b %d, %Y') if reservation.created_at else 'N/A' }}</div>
                                    </td>
                                    <td>{{ reservation.spot.spot_number if reservation.spot else 'N/A' }}</td>
                                    <td>{{ reservation.check_in|localtime('%b %d, %Y %I:%M %p') }}</td>
                                    <td>{{ reservation.check_out|localtime('%b %d, %Y %I:%M %p') if reservation.check_out else 'N/A' }}</td>
                                    <td>
                                        {% if reservation.status == 'active' %}
                                        <span class="badge bg-success">Active</span>
                                        {% elif reservation.status == 'completed' %}
                                        <span class="badge bg-primary">Completed</span>
                                        {% elif reservation.status == 'cancelled' %}
                                        <span class="badge bg-danger">Cancelled</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ reservation.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="fw-bold">
                                            {% if reservation.amount %}${{ '%.2f'|format(reservation.amount) }}{% else %}$0.00{% endif %}
                                        </div>
                                        <div class="text-muted small">
                                            {% if reservation.payment_method %}
                                                {% if reservation.payment_method == 'credit_card' %}
                                                    <i class="fas fa-credit-card me-1"></i>Credit Card
                                                {% elif reservation.payment_method == 'debit_card' %}
                                                    <i class="fas fa-credit-card me-1"></i>Debit Card
                                                {% elif reservation.payment_method == 'upi' %}
                                                    <i class="fas fa-mobile-alt me-1"></i>UPI
                                                {% elif reservation.payment_method == 'net_banking' %}
                                                    <i class="fas fa-university me-1"></i>Net Banking
                                                {% elif reservation.payment_method == 'wallet' %}
                                                    <i class="fas fa-wallet me-1"></i>Wallet
                                                {% elif reservation.payment_method == 'cash' %}
                                                    <i class="fas fa-money-bill me-1"></i>Cash
                                                {% else %}
                                                    {{ reservation.payment_method|title }}
                                                {% endif %}
                                            {% else %}
                                                Not specified
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary view-reservation-btn" data-reservation-id="{{ reservation.id }}" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if reservation.status != 'cancelled' %}
                                            <button type="button" class="btn btn-outline-warning cancel-reservation-btn" data-reservation-id="{{ reservation.id }}" title="Cancel">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-outline-danger delete-reservation-btn" data-reservation-id="{{ reservation.id }}" title="Delete">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="text-muted">No reservations found.</div>
                                        <a href="#" class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addReservationModal">
                                            <i class="fas fa-plus me-1"></i> Add New Reservation
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if reservations.pages > 1 %}
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted">
                            Showing {{ reservations.per_page * (reservations.page - 1) + 1 }} to 
                            {{ reservations.per_page * reservations.page if reservations.page < reservations.pages else reservations.total }} 
                            of {{ reservations.total }} entries
                        </div>
                        <nav aria-label="Reservations pagination">
                            <ul class="pagination pagination-sm mb-0">
                                {% if reservations.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.reservations', page=reservations.prev_num) }}{{ '?' + request.query_string.decode() if request.query_string else '' }}">Previous</a>
                                </li>
                                {% endif %}
                                
                                {% for page_num in reservations.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num != reservations.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('admin.reservations', page=page_num) }}{{ '?' + request.query_string.decode() if request.query_string else '' }}">{{ page_num }}</a>
                                        </li>
                                        {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if reservations.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.reservations', page=reservations.next_num) }}{{ '?' + request.query_string.decode() if request.query_string else '' }}">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Reservation Modal -->
<div class="modal fade" id="addReservationModal" tabindex="-1" aria-labelledby="addReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addReservationModalLabel">Add New Reservation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addReservationForm" method="POST">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="user_id" class="form-label">User</label>
                            <select class="form-select" id="user_id" name="user_id" required>
                                <option value="" selected disabled>Select User</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.full_name or user.username }} ({{ user.email }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="parking_spot_id" class="form-label">Parking Spot</label>
                            <select class="form-select" id="parking_spot_id" name="parking_spot_id" required>
                                <option value="" selected disabled>Select Parking Spot</option>
                                {% for spot in parking_spots %}
                                <option value="{{ spot.id }}" {{ 'disabled' if spot.status != 'A' else '' }}>
                                    {{ spot.spot_number }} - {{ spot.parking_lot.name if spot.parking_lot else 'Unknown Lot' }} 
                                    ({{ 'Available' if spot.status == 'A' else 'Occupied' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="start_time" class="form-label">Check-In Time</label>
                            <input type="datetime-local" class="form-control" id="start_time" name="start_time" required>
                        </div>
                        <div class="col-md-6">
                            <label for="duration" class="form-label">Duration (Hours)</label>
                            <input type="number" class="form-control" id="duration" name="duration" min="1" max="24" value="1" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitReservationBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="reservationSpinner" role="status" aria-hidden="true"></span>
                        <span id="submitBtnText">Create Reservation</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Reservation Modal -->
<div class="modal fade" id="viewReservationModal" tabindex="-1" aria-labelledby="viewReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="viewReservationModalLabel">Reservation Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="reservationDetails">
                <!-- Details will be loaded via AJAX -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading reservation details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printReservationBtn">
                    <i class="fas fa-print me-1"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteReservationModal" tabindex="-1" aria-labelledby="deleteReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteReservationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deleteReservationForm" method="POST" action="">
                <div class="modal-body">
                    <p>Are you sure you want to delete this reservation? This action cannot be undone.</p>
                    <input type="hidden" name="_method" value="DELETE">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Reservation</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- DataTables JavaScript -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
// Define dropdown toggle function in global scope FIRST
function toggleDropdown(dropdownId) {
    console.log('toggleDropdown called with ID:', dropdownId);
    
    try {
        const dropdown = document.getElementById(dropdownId);
        console.log('Found dropdown element:', dropdown);
        
        if (!dropdown) {
            console.error('Dropdown element not found:', dropdownId);
            return;
        }
        
        const menu = dropdown.querySelector('.dropdown-menu');
        console.log('Found menu element:', menu);
        
        if (!menu) {
            console.error('Menu element not found in dropdown:', dropdownId);
            return;
        }
        
        // Close all other dropdowns first
        document.querySelectorAll('.dropdown-menu').forEach(function(openMenu) {
            if (openMenu !== menu) {
                openMenu.style.display = 'none';
                openMenu.classList.remove('show');
            }
        });
        
        // Toggle current dropdown
        if (menu.style.display === 'block' || menu.classList.contains('show')) {
            menu.style.display = 'none';
            menu.classList.remove('show');
            console.log('Dropdown closed');
        } else {
            menu.style.display = 'block';
            menu.classList.add('show');
            console.log('Dropdown opened');
        }
    } catch (error) {
        console.error('Error in toggleDropdown:', error);
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    console.log('Document clicked, target:', event.target);
    
    // Check if click is outside any dropdown
    if (!event.target.closest('.dropdown')) {
        console.log('Click outside dropdown, closing all dropdowns');
        document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            menu.style.display = 'none';
            menu.classList.remove('show');
        });
    }
});

// Test function to verify the function is available
window.testToggle = function() {
    console.log('Test function called');
    toggleDropdown('dropdown1');
};

// Ensure jQuery is loaded
if (typeof jQuery == 'undefined') {
    console.error('jQuery is not loaded!');
    document.write('<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"><\/script>');
}

$(document).ready(function() {
    console.log('Document ready - Reservations page loaded');
    
    // Check Bootstrap availability
    console.log('Bootstrap object:', typeof bootstrap);
    console.log('Bootstrap Dropdown:', typeof bootstrap.Dropdown);
    if (bootstrap && bootstrap.VERSION) {
        console.log('Bootstrap version:', bootstrap.VERSION);
    }
    
    // Remove excessive debugging but keep essential logging
    console.log('Found dropdown toggles:', document.querySelectorAll('.dropdown-toggle').length);
    
    // Force initialize all dropdowns manually
    setTimeout(function() {
        console.log('Manually initializing dropdowns...');
        document.querySelectorAll('.dropdown-toggle').forEach(function(dropdownToggle) {
            // Skip navbar dropdown
            if (dropdownToggle.id.includes('actionsDropdown')) {
                console.log('Initializing dropdown:', dropdownToggle.id);
                try {
                    // Destroy existing instance if any
                    const existingInstance = bootstrap.Dropdown.getInstance(dropdownToggle);
                    if (existingInstance) {
                        existingInstance.dispose();
                    }
                    // Create new instance
                    new bootstrap.Dropdown(dropdownToggle);
                    console.log('Successfully initialized:', dropdownToggle.id);
                } catch (error) {
                    console.error('Error initializing dropdown:', dropdownToggle.id, error);
                }
            }
        });
    }, 500);
    
    // Remove the conflicting click handler to avoid interference
    console.log('jQuery ready function completed');
    
    
    // DataTable initialization removed to use custom pagination instead

    // View reservation details
    $(document).on('click', '.view-reservation-btn', function(e) {
        e.preventDefault();
        console.log('View reservation button clicked!');
        const reservationId = $(this).data('reservation-id');
        console.log('Reservation ID:', reservationId);
        
        if (!reservationId) {
            console.error('No reservation ID found');
            alert('Error: No reservation ID found');
            return;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('viewReservationModal'));
        
        // Show loading state
        $('#reservationDetails').html(`
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading reservation details...</p>
            </div>
        `);
        
        // Show modal first
        modal.show();
        
        // Load reservation details via AJAX
        const apiUrl = `/admin/api/reservations/${reservationId}`;
        console.log('Making AJAX request to:', apiUrl);
        
        $.ajax({
            url: apiUrl,
            method: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                console.log('API Response received:', response);
                
                if (response && response.success && response.reservation) {
                    const res = response.reservation;
                    console.log('Reservation data:', res);
                    const checkIn = res.check_in ? new Date(res.check_in).toLocaleString() : 'N/A';
                    const checkOut = res.check_out ? new Date(res.check_out).toLocaleString() : 'N/A';
                    const user = res.user || {};
                    const spot = res.spot || {};
                    const parkingLot = spot.parking_lot || {};
                    
                    console.log('User data:', user);
                    console.log('Spot data:', spot);
                    console.log('Parking lot data:', parkingLot);
                    
                    // Format status badge
                    let statusClass = 'secondary';
                    if (res.status === 'active') statusClass = 'success';
                    else if (res.status === 'completed') statusClass = 'primary';
                    else if (res.status === 'cancelled') statusClass = 'danger';
                    else if (res.status === 'reversed') statusClass = 'warning';
                    
                    // Calculate duration if both check_in and check_out exist
                    let duration = 'N/A';
                    if (res.check_in && res.check_out) {
                        const start = new Date(res.check_in);
                        const end = new Date(res.check_out);
                        const hours = Math.abs(end - start) / 36e5;
                        duration = `${hours.toFixed(1)} hours`;
                    }
                    
                    const html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-3">Reservation #${res.id || 'N/A'}</h5>
                                <p><strong>Status:</strong> <span class="badge bg-${statusClass}">${res.status ? res.status.charAt(0).toUpperCase() + res.status.slice(1) : 'Unknown'}</span></p>
                                <p><strong>Check-in:</strong> ${checkIn}</p>
                                <p><strong>Check-out:</strong> ${checkOut}</p>
                                <p><strong>Duration:</strong> ${duration}</p>
                                <p><strong>Amount:</strong> $${res.amount ? parseFloat(res.amount).toFixed(2) : '0.00'}</p>
                                <p><strong>Created:</strong> ${res.created_at ? new Date(res.created_at).toLocaleString() : 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <h5 class="mb-3">User Details</h5>
                                <p><strong>Name:</strong> ${user.full_name || user.username || 'N/A'}</p>
                                <p><strong>Username:</strong> ${user.username || 'N/A'}</p>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
                                
                                <h5 class="mt-4">Vehicle Details</h5>
                                <p><strong>Vehicle Registration:</strong> ${res.vehicle_registration || 'Not specified'}</p>
                                <p><strong>Driver's License:</strong> ${res.drivers_license || 'Not specified'}</p>
                                
                                <h5 class="mt-4">Payment Details</h5>
                                <p><strong>Payment Method:</strong> ${formatPaymentMethod(res.payment_method) || 'Not specified'}</p>
                                <p><strong>Payment Status:</strong> ${formatPaymentStatus(res.payment_status) || 'Not paid'}</p>
                                ${res.transaction_id ? `<p><strong>Transaction ID:</strong> ${res.transaction_id}</p>` : ''}
                                ${res.payment_date ? `<p><strong>Payment Date:</strong> ${new Date(res.payment_date).toLocaleString()}</p>` : ''}
                                
                                <h5 class="mt-4">Parking Details</h5>
                                <p><strong>Spot:</strong> ${spot.spot_number || 'N/A'}</p>
                                <p><strong>Parking Lot:</strong> ${parkingLot.name || 'N/A'}</p>
                                <p><strong>Address:</strong> ${parkingLot.address || 'Not specified'}</p>
                                <p><strong>Pincode:</strong> ${parkingLot.pincode || 'Not specified'}</p>
                            </div>
                        </div>
                    `;
                    
                    console.log('Setting HTML content to reservationDetails');
                    $('#reservationDetails').html(html);
                    console.log('HTML content set successfully');
                } else {
                    console.error('Invalid response structure:', response);
                    alert('Failed to load reservation details - invalid response');
                    $('#reservationDetails').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load reservation details - invalid response
                        </div>
                    `);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error
                });
                alert(`Failed to load reservation details. Status: ${xhr.status}, Error: ${error}`);
                $('#reservationDetails').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load reservation details. Status: ${xhr.status}
                    </div>
                `);
            }
        });
    });

    // Handle cancel reservation button click
    $(document).on('click', '.cancel-reservation-btn', function(e) {
        e.preventDefault();
        console.log('Cancel reservation button clicked!');
        const reservationId = $(this).data('reservation-id');
        console.log('Reservation ID to cancel:', reservationId);
        const $btn = $(this);
        
        if (confirm('Are you sure you want to cancel this reservation?')) {
            // Show loading state
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
            
            $.ajax({
                url: `/admin/reservations/${reservationId}/cancel`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: {
                    'csrf_token': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response && response.success) {
                        showToast('Reservation cancelled successfully', 'success');
                        // Reload the page to reflect changes
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showToast(response?.message || 'Failed to cancel reservation', 'error');
                        $btn.prop('disabled', false).html(originalText);
                    }
                },
                error: function(xhr) {
                    console.error('Cancel error:', xhr);
                    let errorMsg = 'An error occurred while processing your request';
                    try {
                        const response = xhr.responseJSON;
                        errorMsg = response?.message || errorMsg;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    showToast(errorMsg, 'error');
                    $btn.prop('disabled', false).html(originalText);
                }
            });
        }
    });

    // Handle add reservation form submission
    $('#addReservationForm').on('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('Form submission triggered');
        
        const $form = $(this);
        const $submitBtn = $('#submitReservationBtn');
        const $spinner = $('#reservationSpinner');
        const $btnText = $('#submitBtnText');
        
        // Prevent duplicate submissions
        if ($submitBtn.prop('disabled')) {
            console.log('Button already disabled, preventing duplicate submission');
            return false;
        }
        
        // Show loading state and disable button immediately
        $submitBtn.prop('disabled', true);
        $spinner.removeClass('d-none');
        $btnText.text('Creating...');
        
        // Get form data
        const formData = $form.serializeArray().reduce(function(obj, item) {
            obj[item.name] = item.value;
            return obj;
        }, {});
        
        // Add CSRF token
        formData['_csrf_token'] = '{{ csrf_token }}';
        
        console.log('Form data being sent:', formData);
        console.log('Start time value:', formData.start_time);
        
        console.log('Sending AJAX request to /admin/reservations/create', formData);
        
        $.ajax({
            url: '/admin/reservations/create',
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: formData,
            success: function(response) {
                console.log('AJAX Success:', response);
                if (response && response.success) {
                    showToast(response.message || 'Reservation created successfully!', 'success');
                    // Close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addReservationModal'));
                    if (modal) {
                        modal.hide();
                    }
                    setTimeout(() => {
                        window.location.href = response.redirect || '/admin/reservations';
                    }, 1000);
                } else {
                    showToast(response?.message || 'Failed to create reservation', 'error');
                    // Re-enable button on error
                    $submitBtn.prop('disabled', false);
                    $spinner.addClass('d-none');
                    $btnText.text('Create Reservation');
                }
            },
            error: function(xhr) {
                console.error('AJAX Error:', xhr);
                console.error('Status:', xhr.status);
                console.error('Response:', xhr.responseText);
                let errorMsg = 'An error occurred while creating the reservation';
                try {
                    const response = xhr.responseJSON;
                    errorMsg = response?.message || errorMsg;
                } catch (e) {
                    console.error('Error parsing error response:', e);
                }
                showToast(errorMsg, 'error');
                // Re-enable button on error
                $submitBtn.prop('disabled', false);
                $spinner.addClass('d-none');
                $btnText.text('Create Reservation');
            }
        });
        
        return false; // Prevent any other form submission
    });
    
    // Reset form when modal is closed
    $('#addReservationModal').on('hidden.bs.modal', function () {
        const $form = $(this).find('form');
        const $submitBtn = $('#submitReservationBtn');
        const $spinner = $('#reservationSpinner');
        const $btnText = $('#submitBtnText');
        
        // Reset form
        $form.trigger('reset');
        
        // Reset button state
        $submitBtn.prop('disabled', false);
        $spinner.addClass('d-none');
        $btnText.text('Create Reservation');
        
        // Set default datetime to current time
        const now = new Date();
        // Format to YYYY-MM-DDTHH:MM (local time)
        const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        $('#start_time').val(localISOTime);
    });
    
    // Also set default time when modal is first shown
    $('#addReservationModal').on('shown.bs.modal', function () {
        const now = new Date();
        const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        if (!$('#start_time').val()) {
            $('#start_time').val(localISOTime);
        }
        
        // Move focus to a safe element after modal is shown
        setTimeout(function() {
            $('body').focus();
        }, 100);
    });
    
    // Ensure all buttons have tooltips
    $('[title]').tooltip();
    
    // Handle export button click
    $('#exportBtn').on('click', function() {
        alert('Export functionality would go here');
    });
    
    // Handle delete reservation button click
    $(document).on('click', '.delete-reservation-btn', function(e) {
        e.preventDefault();
        console.log('Delete reservation button clicked!');
        const reservationId = $(this).data('reservation-id');
        console.log('Reservation ID to delete:', reservationId);
        
        if (confirm('Are you sure you want to delete this reservation? This action cannot be undone.')) {
            const $btn = $(this);
            const originalText = $btn.html();
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...');
            
            $.ajax({
                url: `/admin/reservations/${reservationId}/delete`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                data: {
                    'csrf_token': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response && response.redirect) {
                        showToast('Reservation deleted successfully', 'success');
                        // Reload the page to reflect changes
                        setTimeout(() => window.location.href = response.redirect, 1000);
                    } else {
                        showToast(response?.message || 'Reservation deleted successfully', 'success');
                        // Fallback reload if no redirect
                        setTimeout(() => window.location.reload(), 1000);
                    }
                },
                error: function(xhr) {
                    console.error('Delete error:', xhr);
                    let errorMsg = 'An error occurred while deleting the reservation';
                    try {
                        const response = xhr.responseJSON;
                        errorMsg = response?.message || errorMsg;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    showToast(errorMsg, 'error');
                    $btn.prop('disabled', false).html(originalText);
                }
            });
        }
    });

    // Print reservation
    $('#printReservationBtn').on('click', function() {
        window.print();
    });

    // Show toast notification function
    function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white bg-${type} border-0`;
        toast.role = 'alert';
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        const toastBody = document.createElement('div');
        toastBody.className = 'd-flex';
        
        const toastContent = document.createElement('div');
        toastContent.className = 'toast-body';
        
        // Add icon based on message type
        let icon = 'info-circle';
        if (type === 'success') icon = 'check-circle';
        if (type === 'error') icon = 'exclamation-triangle';
        if (type === 'warning') icon = 'exclamation-circle';
        
        toastContent.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>
            ${message}
        `;
        
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'btn-close btn-close-white me-2 m-auto';
        closeButton.setAttribute('data-bs-dismiss', 'toast');
        closeButton.setAttribute('aria-label', 'Close');
        
        toastBody.appendChild(toastContent);
        toastBody.appendChild(closeButton);
        toast.appendChild(toastBody);
        
        // Add to container
        toastContainer.appendChild(toast);
        
        // Auto-remove after delay
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 150);
        }, 5000);
        
        // Close on click
        closeButton.addEventListener('click', () => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 150);
        });
    }
});

// Helper functions for formatting (global scope)
function formatPaymentMethod(method) {
    if (!method) return 'Not specified';
    
    const methods = {
        'credit_card': 'Credit Card',
        'debit_card': 'Debit Card',
        'upi': 'UPI',
        'net_banking': 'Net Banking',
        'wallet': 'Digital Wallet',
        'cash': 'Cash',
        'bank_transfer': 'Bank Transfer'
    };
    
    return methods[method] || method.charAt(0).toUpperCase() + method.slice(1).replace('_', ' ');
}

function formatPaymentStatus(status) {
    if (!status) return 'Not specified';
    
    const statuses = {
        'pending': 'Pending',
        'paid': 'Paid',
        'failed': 'Failed',
        'refunded': 'Refunded',
        'cancelled': 'Cancelled',
        'processing': 'Processing'
    };
    
    return statuses[status] || status.charAt(0).toUpperCase() + status.slice(1);
}
</script>


<script>
$(document).ready(function() {
    console.log('Reservations page loaded, initializing dropdowns');
    
    // Force initialize all dropdowns on this page
    document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(function(element) {
        try {
            // Create new dropdown instance directly
            new bootstrap.Dropdown(element);
        } catch (e) {
            console.error('Error initializing dropdown:', e);
        }
        
        // Add a direct click handler as a failsafe
        element.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Get the dropdown menu
            var dropdownMenu = this.nextElementSibling;
            if (!dropdownMenu || !dropdownMenu.classList.contains('dropdown-menu')) {
                dropdownMenu = this.parentElement.querySelector('.dropdown-menu');
            }
            
            // Toggle the show class
            if (dropdownMenu) {
                dropdownMenu.classList.toggle('show');
            }
        });
    });
});
</script>

<!-- Direct dropdown fix script -->
<script>
// Direct fix for dropdown buttons - runs immediately
(function() {
    function fixDropdowns() {
        console.log('Applying direct dropdown fixes');
        
        // Get all dropdown toggle buttons
        var dropdownButtons = document.querySelectorAll('.dropdown-toggle');
        console.log('Found', dropdownButtons.length, 'dropdown buttons');
        
        // Add direct click handlers to each button
        dropdownButtons.forEach(function(button) {
            // Remove existing listeners to avoid duplicates
            button.removeEventListener('click', handleDropdownClick);
            // Add new click handler
            button.addEventListener('click', handleDropdownClick);
        });
    }
    
    function handleDropdownClick(event) {
        event.preventDefault();
        event.stopPropagation();
        
        // Find the dropdown menu
        var dropdownMenu = this.nextElementSibling;
        
        // If the next element isn't the menu, find it in the parent
        if (!dropdownMenu || !dropdownMenu.classList.contains('dropdown-menu')) {
            dropdownMenu = this.parentElement.querySelector('.dropdown-menu');
        }
        
        if (!dropdownMenu) {
            console.error('Could not find dropdown menu for', this);
            return;
        }
        
        // Close all other menus
        document.querySelectorAll('.dropdown-menu.show').forEach(function(menu) {
            if (menu !== dropdownMenu) {
                menu.classList.remove('show');
            }
        });
        
        // Toggle this menu
        dropdownMenu.classList.toggle('show');
        
        // Ensure proper positioning
        if (dropdownMenu.classList.contains('show')) {
            var btnRect = this.getBoundingClientRect();
            var menuRect = dropdownMenu.getBoundingClientRect();
            
            // Handle right edge overflow
            if (menuRect.right > window.innerWidth) {
                dropdownMenu.classList.add('dropdown-menu-end');
            }
        }
        
        // Add click outside handler
        setTimeout(function() {
            document.addEventListener('click', function closeMenu(e) {
                if (!dropdownMenu.contains(e.target) && e.target !== this) {
                    dropdownMenu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            }.bind(this));
        }.bind(this), 0);
    }
    
    // Run on page load
    fixDropdowns();
    
    // Also run after the page is fully loaded
    window.addEventListener('load', fixDropdowns);
    
    // Run periodically to catch any dynamically added dropdowns
    setInterval(fixDropdowns, 1000);
})();
</script>
{% endblock %}